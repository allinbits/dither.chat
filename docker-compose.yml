services:
  # ================================
  # Database Services
  # ================================
  postgres-feed:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_DB: feed
      POSTGRES_USER: username
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"

  # ================================
  # Event Consuming Services
  # ================================
  post-service:
    container_name: "post-service"
    build: ./packages/post-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_ENDPOINT: "amqp://guest:guest@rabbitmq:5672"
      RABBITMQ_EXCHANGE: "dither"
    restart: always
    command: ["pnpm", "start"]
    
  reply-service:
    container_name: "reply-service"
    build: ./packages/reply-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_ENDPOINT: "amqp://guest:guest@rabbitmq:5672"
      RABBITMQ_EXCHANGE: "dither"
    restart: always
    command: ["pnpm", "start"]

  like-service:
    container_name: "like-service"
    build: ./packages/like-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_ENDPOINT: "amqp://guest:guest@rabbitmq:5672"
      RABBITMQ_EXCHANGE: "dither"
    restart: always
    command: ["pnpm", "start"]

  dislike-service:
    container_name: "dislike-service"
    build: ./packages/dislike-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_ENDPOINT: "amqp://guest:guest@rabbitmq:5672"
      RABBITMQ_EXCHANGE: "dither"
    restart: always
    command: ["pnpm", "start"]

  follow-service:
    container_name: "follow-service"
    build: ./packages/follow-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_ENDPOINT: "amqp://guest:guest@rabbitmq:5672"
      RABBITMQ_EXCHANGE: "dither"
    restart: always
    command: ["pnpm", "start"]
  unfollow-service:
    container_name: "unfollow-service"
    build: ./packages/unfollow-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_ENDPOINT: "amqp://guest:guest@rabbitmq:5672"
      RABBITMQ_EXCHANGE: "dither"
    restart: always
    command: ["pnpm", "start"]
  flag-service:
    container_name: "flag-service"
    build: ./packages/flag-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_ENDPOINT: "amqp://guest:guest@rabbitmq:5672"
      RABBITMQ_EXCHANGE: "dither"
    restart: always
    command: ["pnpm", "start"]
  # ================================
  # ChronoSync Services (Readers)
  # ================================
  reader-main:
    container_name: "reader-main"
    build: ./packages/reader-main
    restart: always
    command: ["pnpm", "start"]
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_ENDPOINT: "amqp://guest:guest@rabbitmq:5672"
      RABBITMQ_EXCHANGE: "dither"
      API_URLS: "https://atomone-api.allinbits.com,https://atomone-rest.publicnode.com"
      START_BLOCK: "2605764"
      BATCH_SIZE: 50
      MEMO_PREFIX: "dither."
      RECEIVER: "atone1uq6zjslvsa29cy6uu75y8txnl52mw06j6fzlep"
      # PG_URI: postgres://username:password@postgres-feed:5432/feed
      # LOG: process.env.LOG === 'true' ? true : false,

  # ================================
  # RabbitMQ Service (event system)
  # ================================
  rabbitmq:
    image: rabbitmq:latest
    build: ./packages/rabbit-mq
    container_name: rabbitmq
    restart: always
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 3
    ports:
      - 5672:5672
      - 15672:15672
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq-lib:/var/lib/rabbitmq/
      - rabbitmq-log:/var/log/rabbitmq

volumes:
  rabbitmq-lib:
    driver: local
  rabbitmq-log:
    driver: local

  # ================================
  # REST Services
  # ================================
  # api-feed:
  #     container_name: "api-feed"
  #     build: ./packages/api-feed
  #     restart: always
  #     command: ['pnpm', 'start']
  #     depends_on:
  #         - mongodb-indexer-feed
  #     environment:
  #         MONGO_URI: mongodb://username:password@mongodb-indexer-feed:27017/
  #         PORT: 3000
  #     ports:
  #         - 3000:3000

  # api-likes:
  #     container_name: "api-likes"
  #     build: ./packages/api-likes
  #     restart: always
  #     command: ['pnpm', 'start']
  #     depends_on:
  #         - mongodb-indexer-likes
  #     environment:
  #         MONGO_URI: mongodb://username:password@mongodb-indexer-likes:27017/
  #         PORT: 3001
  #     ports:
  #         - 3001:3001

  # ================================
  # Gateway Service
  # ================================
  # nginx:
  #     image: nginx:latest
  #     volumes:
  #     - ./packages/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
  #     ports:
  #     - "80:80"
  #     depends_on:
  #     - api-feed